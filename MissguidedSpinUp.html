<html>
    <head>
        <!-- A version of jquery for easy data loading -->
       <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
        <!-- include the handlebars runtime -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
        <!-- include the visualization SDK for real-time updates -->
        <script type="text/javascript" src="https://unpkg.com/dc-visualization-sdk/dist/lib/dc-visualization-sdk.umd.js"></script>
        <!-- Some example styling -->
    <style>
    @import url(https://fonts.googleapis.com/css?family=Roboto);

    /* HTML reset to use border box sizing*/
    html, body {
      box-sizing: border-box;
    }
    body * {
      box-sizing: inherit;
    }
    .banner {
      position: relative;
      width: 100%;
    }
    .banner-editorial {
      position: absolute;
      top: 20px;
      width: 100%;
      padding: 0 20px;
      text-align: left;
      font:Roboto;
      color: white;
      font-family: Roboto;
    }
    .banner-header {
      font-size: 30px;
    }
    .banner-background-image {
      width: 100%;
      height: auto;
    }
    .banner-call-to-action {
      position: absolute;
      bottom: 20px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      right: 20px;
      padding: 10px;
      text-decoration: none;
      font-family: Roboto;
    }
    .banner-call-to-action:hover {
      background-color: rgba(0, 0, 0, 1);
    }
    .banner-call-to-action:after {
      content: ' >'
    }
    </style>
    </head>
    <body>
       <div id="contentRender"></div>
        <!-- Handlebars Template to render content -->
        <script id="tutorial-template" type="text/x-handlebars-template">
          {{#with content}}
           <div class="banner">
            <div class="banner-editorial">
              <div class="banner-header">{{header}}</div>
              <div class="banner-subheader">{{subheading}}</div>
            </div>
                <!-- construct image URL from the data. Chose to default to HTTPS -->

                <img class="banner-background-image" src="https://{{image.defaultHost}}/i/{{image.endpoint}}/{{image.name}}">
                <a class="banner-call-to-action" href="{{cta.propertyName2}}">{{cta.propertyName1}}</a>
          </div>
          {{/with}}
          </script>
        <script>

      function showErrorMessage(err) {
          console.log('Delivery API Request Failure', err);
          $(document.body).append('<div class="error">An error occurred retrieving your content.<br/><br/>Details of the error have been saved to the browser console.</div>');
        }


     function loadContent()

      {
           console.log('in load content');
   		   // build the query for content delivery 2
		   const contentDeliveryUrl = `//${getQueryVar('api')}/content/id/${getQueryVar('content')}?depth=all&format=inlined`;


		   console.log("This is the URL");
		   console.log(contentDeliveryUrl);


			var deliveryRequest = $.ajax({
			  url: contentDeliveryUrl
			});
			// render the content or display error response
			deliveryRequest
			  .done(renderContent)
			  .fail(showErrorMessage);
       }

      function getQueryVar(variable) {
        var query = window.location.search.substring(1);
        console.log('query');
        console.log(query);

        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            if (decodeURIComponent(pair[0]) == variable) {
                console.log('decoded URL')
                console.log(decodeURIComponent(pair[1]));

                return decodeURIComponent(pair[1]);
            }
        }
        return false;
    }


        function renderContent(content) {
          console.log("In render content");

          console.log("This is the result:");
          console.log(JSON.stringify(content));
          console.log("---");
          // render the content using the template
          var html = template(content);
          $("#contentRender").html(html);
        }


       async function connect() {
          try{
            const sdk = await dcVisualizationSdk.init();

            sdk.form.changed((update)  => renderContent(update));

             renderContent(await sdk.form.get());
          } catch(e){
            console.error(e);
          }
        }

        // fetch the Handlebars template from the DOM
        var templateSource = $('#tutorial-template').html();
        var template = Handlebars.compile(templateSource);

        // connect to the visualization SDK.
        connect();



        </script>
    </body>
</html>
